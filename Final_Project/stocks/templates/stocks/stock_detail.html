{% extends 'stocks/base.html' %}
{% load humanize %}

{% block title %}{{ stock.company_name }}{% endblock %}

{% block content %}
<div class="row mt-4">
  <div class="col-md-4">
    <img src="{{ stock.logo.url }}" class="img-fluid" alt="{{ stock.company_name }}">
  </div>
  <div class="col-md-8">
    <h2>{{ stock.company_name }} ({{ stock.symbol }})</h2>
    <p><strong>Current Price:</strong> ${{ stock.current_price|floatformat:2 }}</p>
    <p><strong>Market Cap:</strong> ${{ stock.market_cap|intcomma }}</p>
    <p><strong>Year Founded:</strong> {{ stock.year_founded }}</p>
    <p><strong>Description:</strong></p>
    <p>{{ stock.description }}</p>

    {% if user.is_authenticated %}
    <form method="post">
      {% csrf_token %}
      <button type="submit" name="ai_summary" class="btn btn-warning">AI Summary-What the company does?</button>
    </form>
    {% else %}
    <div class="alert alert-info">
      <strong>Want to get AI insights?</strong>
      <a href="{% url 'stocks:login' %}" class="btn btn-primary btn-sm">Login</a>
      or
      <a href="{% url 'stocks:signup' %}" class="btn btn-success btn-sm">Sign Up</a>
      to access AI features!
    </div>
    {% endif %}

    {% if ai_summary %}
    <div class="mt-3 alert alert-info">
      <h5>The company specializes in:</h5>
      <p>{{ ai_summary }}</p>
    </div>
    {% endif %}

    <!-- Reviews Section -->
    <hr class="mt-4">
    <h3>Reviews</h3>

    {% if user.is_authenticated %}
      <!-- Form for adding/updating review -->
      <div class="card mt-3">
        <div class="card-header">
          <h5>{% if user_review %}Update Your Review{% else %}Write a Review{% endif %}</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label for="rating" class="form-label">Rating (1-5 stars)</label>
              <select name="rating" id="rating" class="form-select" required>
                <option value="">Select Rating</option>
                {% for i in "12345" %}
                <option value="{{ i }}" {% if user_review.rating == i|add:0 %}selected{% endif %}>{{ i }} Star{{ i|add:0|pluralize }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="comment" class="form-label">Your Review</label>
              <textarea name="comment" id="comment" class="form-control" rows="4" required maxlength="500" placeholder="Share your thoughts about this stock...">{% if user_review %}{{ user_review.comment }}{% endif %}</textarea>
              <div class="form-text">Maximum 500 characters</div>
            </div>
            <button type="submit" name="review_submit" class="btn btn-success">
              {% if user_review %}Update Review{% else %}Submit Review{% endif %}
            </button>
          </form>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">
        <strong>Want to share your thoughts?</strong>
        <a href="{% url 'stocks:login' %}" class="btn btn-primary btn-sm">Login</a>
        or
        <a href="{% url 'stocks:signup' %}" class="btn btn-success btn-sm">Sign Up</a>
        to write a review!
      </div>
    {% endif %}

    <!-- Display existing reviews -->
    {% if reviews %}
    <div class="mt-4">
      <h4>User Reviews ({{ reviews.count }})</h4>
      {% for review in reviews %}
      <div class="card mt-2">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <h6 class="card-title">
              {{ review.user.username }}
              <span class="text-warning">
                {% for i in "12345" %}
                  {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
                {% endfor %}
              </span>
            </h6>
            <small class="text-muted">{{ review.created_at|date:"M d, Y" }}</small>
          </div>
          <p class="card-text">{{ review.comment }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="mt-4">
      <p class="text-muted">No reviews yet. Be the first to review this stock!</p>
    </div>
    {% endif %}

    <a href="{% url 'stocks:stock_list' %}" class="btn btn-secondary mt-4">Back to Stocks</a>
  </div>
</div>
{% endblock %}
